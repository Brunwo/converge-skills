#!/bin/bash
set -euo pipefail

SKILLS_ACTIVE="skills-active"
SKILLS_REPOS="skills-repos"
SKILLS_USER="skills-user"
CONFIG=".skillsync/active-skills.json"

# Initialize config directory
mkdir -p .skillsync

# Add sparse submodule
add_sparse_submodule() {
    local url=$1
    local name=$2
    local initial_paths=${3:-}
    local branch=${4:-}

    echo "Adding sparse submodule: $name"

    # Add as submodule (with optional branch)
    if [ -n "$branch" ]; then
        git submodule add -b "$branch" "$url" "$SKILLS_REPOS/$name"
    else
        git submodule add "$url" "$SKILLS_REPOS/$name"
    fi

    # Configure sparse checkout
    cd "$SKILLS_REPOS/$name"
    git sparse-checkout init --cone
    git config core.sparseCheckout true

    # Clear working directory of any files that shouldn't be there
    git ls-files --others --cached | xargs -r rm -f
    find . -maxdepth 1 -type f -not -name '.git' -not -name '.gitmodules' | xargs -r rm -f

    if [ -n "$initial_paths" ]; then
        git sparse-checkout set --skip-checks $initial_paths
    fi

    git checkout
    cd ../..

    # Save to .gitmodules metadata
    git config -f .gitmodules "submodule.$SKILLS_REPOS/$name.sparse" "true"
    git config -f .gitmodules "submodule.$SKILLS_REPOS/$name.sparse-checkout" "$initial_paths"
}

# Activate skills (create symlinks)
activate_skills() {
    local skills_json=$1

    # Create/clear active directory
    mkdir -p "$SKILLS_ACTIVE"

    # Remove old symlinks
    find "$SKILLS_ACTIVE" -type l -delete

    # Parse JSON and create symlinks
    echo "$skills_json" | jq -r '.[] | "\(.id)|\(.source)|\(.path)"' | while IFS='|' read -r id source path; do
        local target
        case "$source" in
            user)
                target="../$SKILLS_USER/$path"
                ;;
            *)
                target="../$SKILLS_REPOS/$source/skills/$path"
                ;;
        esac

        if [ -d "${target#../}" ]; then
            ln -sf "$target" "$SKILLS_ACTIVE/$id"
            echo "✓ Activated: $id → $target"
        else
            echo "⚠ Warning: $target not found, skipping $id"
        fi
    done

    # Save config
    echo "$skills_json" | jq '.' > "$CONFIG"
}

# Add skill to sparse checkout and activate
add_skill() {
    local source=$1
    local skill_path=$2
    local skill_id=${3:-$(basename "$skill_path")}

    # Update sparse checkout
    if [ "$source" != "user" ]; then
        cd "$SKILLS_REPOS/$source"
        git sparse-checkout add --skip-checks "skills/$skill_path/*"
        git checkout HEAD  # materialize files
        cd ../..

        # Update .gitmodules
        local current=$(git config -f .gitmodules "submodule.$SKILLS_REPOS/$source.sparse-checkout" || echo "")
        git config -f .gitmodules "submodule.$SKILLS_REPOS/$source.sparse-checkout" "$current skills/$skill_path/*"
    fi

    # Add to config
    local new_skill=$(jq -n \
        --arg id "$skill_id" \
        --arg source "$source" \
        --arg path "$skill_path" \
        '{id: $id, source: $source, path: $path}')

    if [ -f "$CONFIG" ]; then
        local updated=$(jq --argjson new "$new_skill" '. + [$new]' "$CONFIG")
    else
        local updated="[$new_skill]"
    fi

    activate_skills "$updated"
}

# Remove skill
remove_skill() {
    local skill_id=$1

    # Remove from config
    local updated=$(jq --arg id "$skill_id" 'map(select(.id != $id))' "$CONFIG")

    # Remove symlink
    rm -f "$SKILLS_ACTIVE/$skill_id"

    echo "$updated" | jq '.' > "$CONFIG"
    echo "✗ Deactivated: $skill_id"
}

# List active skills
list_skills() {
    if [ -f "$CONFIG" ]; then
        jq -r '.[] | "\(.id)\t(\(.source):\(.path))"' "$CONFIG"
    else
        echo "No skills activated yet"
    fi
}

# Restore from config (for post-clone/post-checkout)
restore() {
    if [ ! -f "$CONFIG" ]; then
        echo "No saved configuration found"
        exit 1
    fi

    local skills=$(cat "$CONFIG")
    activate_skills "$skills"
}

# Main command dispatcher
case "${1:-}" in
    add-repo)
        add_sparse_submodule "$2" "$3" "${4:-}" "${5:-}"
        ;;
    add)
        add_skill "$2" "$3" "${4:-}"
        ;;
    remove)
        remove_skill "$2"
        ;;
    list)
        list_skills
        ;;
    restore)
        restore
        ;;
    *)
        cat << 'EOF'
Usage: skillsync <command> [args]

Commands:
  add-repo <url> <name> [initial_paths] [branch]   Add sparse submodule
  add <source> <path> [id]                Activate skill
  remove <id>                             Deactivate skill
  list                                    List active skills
  restore                                 Restore symlinks from config

Examples:
  skillsync add-repo https://github.com/base-org/skills base "skills/postgres-patterns/*"
  skillsync add-repo https://github.com/vercel-labs/agent-skills vercel "skills/" install
  skillsync add base saas-multitenancy
  skillsync add user custom-stripe
  skillsync list
  skillsync remove saas-multitenancy
  skillsync restore
EOF
        ;;
esac
